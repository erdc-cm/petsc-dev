#! /bin/csh
# $Id: buildtest,v 1.2 2001/10/19 16:20:25 petsc Exp $ 
# 
# Compiles and tests PETSc in our nightly builds.
# Run as buildtest ARCH where ARCH is one of the PETSc archs
# This script runs on terra, and uses terra:/sandbox/petsc/petsc-test
#
# Example usage: buildtest solaris
#
set DATAFILESPATH=/home/petsc/datafiles
set NICE=''
set APPEND='>>&'
set RSH='ssh -1'
set RCP='scp -q -B -oProtocol=1'
set CONFIGURE='no'
set ARCH=$1
set dir=`dirname $0`
source $dir/buildtests/$1
set dir=`dirname $dir`


rsync -z -e "$RSH" -C -r --exclude=BitKeeper --delete $dir/* ${MACH}:$TMP
# should delete all previously build libraries


$RSH $MACH -n "cd $TMP/maint;touch build_$ARCH.$BOPT.$MACH.log examples_$ARCH.$BOPT.$MACH.log"
$RSH $MACH -n "cd $TMP;echo 'Build on $MACH $ARCH $BOPT `date` ' $APPEND maint/build_$ARCH.$BOPT.$MACH.log"

# Run Configure
if ("${CONFIGURE}" == "yes") then
  $RSH $MACH -n "cd $TMP; config/configure_$ARCH.py $APPEND maint/build_$ARCH.$BOPT.$MACH.log"
  $RSH $MACH -n "cd $TMP;echo '****************************************************' $APPEND maint/build_$ARCH.$BOPT.$MACH.log"
  set EJOBS=`$RSH $MACH -n cat $TMP/bmake/$1/ejobs`
  set JOBS=`$RSH $MACH -n cat $TMP/bmake/$1/jobs`
else
#  Get the list of packages installed on the machine WHERE THE BUILD IS HAPPENING
  set EJOBS=`$RSH $MACH -n grep PETSC_HAVE_ $TMP/bmake/$1/packages | grep -v "#" | grep -v '\$' | sed -e "s/^PETSC_HAVE_\([A-Z0-9_]*\) [- a-zA-Z_0-9=]*/\1/g" | grep -v DPETSC`
endif

if ("${BOPT}" == "g_complex" ||  "${BOPT}" == "O_complex") then
  set EJOBS=""
endif


$RSH $MACH -n "cd $TMP;make PETSC_ARCH=$ARCH PETSC_DIR=$TMP BOPT=$BOPT all $APPEND maint/build_$ARCH.$BOPT.$MACH.log"
$RSH $MACH -n "cd $TMP;echo '****************************************************' $APPEND maint/build_$ARCH.$BOPT.$MACH.log"
$RSH $MACH -n "cd $TMP;echo 'Finished Build on $MACH $ARCH $BOPT `date`' $APPEND maint/build_$ARCH.$BOPT.$MACH.log"
#
#
#
# Run examples
$RSH $MACH -n "cd $TMP ;echo 'Build on $MACH $ARCH  $BOPT `date` ' $APPEND maint/examples_$ARCH.$BOPT.$MACH.log"
foreach j ($JOBS $EJOBS)
  $RSH $MACH -n "cd $TMP; $NICE make PETSC_ARCH=$ARCH PETSC_DIR=$TMP BOPT=$BOPT ACTION=$TEST$j DATAFILESPATH=$DATAFILESPATH tree | grep -v 'up to date' $APPEND maint/examples_$ARCH.$BOPT.$MACH.log"
  $RSH $MACH -n "cd $TMP;echo '******************************************************' $APPEND maint/examples_$ARCH.$BOPT.$MACH.log"
end
$RSH $MACH -n "cd $TMP ;echo 'Finished Build on $MACH $ARCH $BOPT `date`' $APPEND maint/examples_$ARCH.$BOPT.$MACH.log"
$RSH $MACH -n "cd $TMP ;echo 'X******************************************************X' $APPEND maint/examples_$ARCH.$BOPT.$MACH.log"



